<!DOCTYPE html>
<html>
  <head>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
  </head>
  <body>
<div id="map"></div>
<style>
#map {
width: 800px;
height: 800px;
}
.crime {
 fill: transparent;
 stroke: rgba(0, 0, 0, 0.7);
 stroke-width:2px;
}
.crime text {
  font: 0.8rem arial, sans-serif;
}
.district {
  fill: rgba(0, 0, 0, 0.4)
}
</style>
<script type="text/javascript">
d3.select(window).on('load', () => {
  const width = window.innerWidth * 0.8;
  const height = window.innerHeight * 0.8;

  document.getElementById("map").style.height = height + "px";
  document.getElementById("map").style.width = width + "px";
  const map = new L.Map("map", {center: [37.75135, -122.4399], zoom: 12})
    .addLayer(new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"));

  function projectPoint(x, y) {
    var point = map.latLngToLayerPoint(new L.LatLng(y, x));
    this.stream.point(point.x, point.y);
  }

d3.json("sfpd_districts.geojson", json_districts => {

  d3.json("sf_crime.geojson", json => {
    const projection = d3.geoTransform({point: projectPoint})

    const svg = d3.select(map.getPanes().overlayPane).append("svg")
      .attr("width", width)
      .attr("height", height)
    const g = svg.append("g").attr("class", "leaflet-zoom-hide");

    const path = d3.geoPath(projection)

    // Add districts
    const g_d = svg.append("g").attr("class", "leaflet-zoom-hide");
    const districts = g_d.selectAll(".district")
      .data(json_districts.features)
      .enter()
      .append("path")
      .attr("class", "district")
      
    districts.attr("d", path)

    // Add points
    const feature = g.selectAll(".crime")
      .data(json.features)
      .enter()
      .append("path")
      .attr("class", d => "crime " + d.properties.Category.slice(0, 3))

    feature.attr("d", path)

    // Extract crime categories
    const categories = function() {
	const tmp = json.features.map(f => f.properties.Category);
	return tmp.filter((v, i, a) => a.indexOf(v) == i);
    }()
    const categoryScale = d3.scaleBand().domain(categories).range([82, height])
    const types = svg.append("g")
       .selectAll(".type")
       .data(categories)
       .enter()
       .append("text")
       .attr("x", 10)
       .attr("y", (d => categoryScale(d)))
       .text(d => d)
       .on("mouseover", d => {
	   console.log(d3.selectAll("path:not(." + d.slice(0, 3) + ")"))
	   d3.selectAll(".crime:not(." + d.slice(0, 3) + ")").style("opacity", 0)
	   d3.selectAll("." + d.slice(0, 3)).style("opacity", 1)
	})
    
    // Reposition the SVG to cover the features.
    function reset() {
      var bounds = path.bounds(json),
        topLeft = bounds[0],
        bottomRight = bounds[1];

      //svg.style("left", topLeft[0] + "px")
       //  .style("top", topLeft[1] + "px")
	 

      g .attr("width", bottomRight[0] - topLeft[0])
        .attr("height", bottomRight[1] - topLeft[1])
        .style("left", topLeft[0] + "px")
        .style("top", topLeft[1] + "px");
      g_d.attr("width", bottomRight[0] - topLeft[0])
        .attr("height", bottomRight[1] - topLeft[1])
        .style("left", topLeft[0] + "px")
        .style("top", topLeft[1] + "px");

      feature.attr("d", path);
      districts.attr("d", path);
    }
    map.on("zoomend", reset);
    map.on("moveend", reset);

    // prepare the map
    reset();

  })
});
});
</script>
</body>
</html>
